blueprint:
  name: "IKEA Bilresa Scroll Wheel – Volume Control (Right & Left)"
  description: "Universal Volume Control for IKEA Bilresa Scroll Wheel using current volume only"
  domain: automation

  input:
    scrollwheel_right_event_entity:
      name: "Scroll Wheel Event Entity – Right Rotation"
      description: "Event Entity of the Scroll Wheel for right rotation"
      selector:
        entity:
          domain: event

    scrollwheel_left_event_entity:
      name: "Scroll Wheel Event Entity – Left Rotation"
      description: "Event Entity of the Scroll Wheel for left rotation"
      selector:
        entity:
          domain: event

    target_media_player:
      name: "Target Media Player"
      description: "Media player to control volume"
      selector:
        entity:
          domain: media_player

    volume_per_step_right:
      name: "Volume per Step – Right (%)"
      default: 5
      selector:
        number:
          min: 1
          max: 20

    volume_per_step_left:
      name: "Volume per Step – Left (%)"
      default: 5
      selector:
        number:
          min: 1
          max: 20

trigger:
  - platform: state
    entity_id: !input scrollwheel_right_event_entity
    id: right_scroll

  - platform: state
    entity_id: !input scrollwheel_left_event_entity
    id: left_scroll

action:
  - variables:
      is_right_scroll: "{{ trigger.id == 'right_scroll' }}"
      target_entity: !input target_media_player

      # Direction: Right = +1, Left = -1
      direction: "{{ 1 if is_right_scroll else -1 }}"

      # Volume step in %
      volume_step: >-
        {{ volume_per_step_right if is_right_scroll else volume_per_step_left }}

      # Extract press count
      press_count: >-
        {{ trigger.to_state.attributes.totalNumberOfPressesCounted | int(1) }}

      # Current volume (0.0 – 1.0)
      current_volume: "{{ state_attr(target_entity, 'volume_level') | float(0) }}"

      # Calculate volume change
      volume_change: "{{ (volume_step | int * press_count | int * direction) / 100 }}"

      # Clamp final volume
      new_volume: >-
        {% set v = current_volume + volume_change %}
        {% if v < 0 %}
          0
        {% elif v > 1 %}
          1
        {% else %}
          {{ v }}
        {% endif %}

  - service: media_player.volume_set
    target:
      entity_id: !input target_media_player
    data:
      volume_level: "{{ new_volume }}"

mode: queued
max: 20
